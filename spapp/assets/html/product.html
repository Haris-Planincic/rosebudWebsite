<header class="bg-dark py-5">
  <div class="container px-4 px-lg-5 my-5">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder" id="productName"></h1>
    </div>
  </div>
</header>

<section class="py-5">
  <div class="container px-4 px-lg-5">
    <div class="row justify-content-center">

      <div class="col-lg-9">
        <div class="card shadow-sm border-0">
          <div class="card-body p-5">

            <div class="row align-items-start">

              <div class="col-md-6 text-center mb-4 mb-md-0">
                <img id="productImage"
                     class="img-fluid rounded"
                     style="max-height: 400px; object-fit: contain;"
                     alt="">
              </div>

              <div class="col-md-6">
                <h3 id="productPrice" class="mb-3 text-muted"></h3>

                <p id="productDescription" class="mb-4"></p>

                <p class="text-muted mb-4">
                  Posted by:
                  <strong id="productSeller"></strong>
                </p>

                <div id="purchaseArea" class="mt-4"></div>
                <div id="ownerArea" class="mt-3"></div>
              </div>

            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- ================= EDIT MODAL ================= -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit your listing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="editError" class="alert alert-danger d-none"></div>
        <div id="editSuccess" class="alert alert-success d-none"></div>

        <form id="editProductForm">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label">Product name</label>
              <input type="text" class="form-control" id="editProductName">
            </div>

            <div class="col-md-6">
              <label class="form-label">Price</label>
              <input type="number" step="0.01" class="form-control" id="editProductPrice">
            </div>

            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" rows="4" id="editProductDescription"></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">Replace image (optional)</label>
              <input type="file"
                     class="form-control"
                     id="editProductImage"
                     accept=".jpg,.jpeg,.png,.webp">
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveEditBtn">Save changes</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Delete listing?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-warning mb-0">
          This will permanently delete your listing. This cannot be undone.
        </div>
        <div id="deleteError" class="alert alert-danger d-none mt-3"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Yes, delete</button>
      </div>

    </div>
  </div>
</div>

<script>
  console.log("PRODUCT PAGE SCRIPT LOADED ✅", new Date().toISOString());
let lastStripePaymentId = null;
let lastStripeProductId = null;

// hard fail messages (so you see something even if later code crashes)
if (typeof window.$ === "undefined") {
  console.error("jQuery ($) is NOT loaded on this view. Product page JS cannot run.");
}
if (typeof window.productService === "undefined") {
  console.error("productService is NOT loaded on this view.");
}
if (typeof window.paymentService === "undefined") {
  console.warn("paymentService is NOT loaded (only needed for checkout).");
}
if (typeof window.bootstrap === "undefined") {
  console.warn("bootstrap JS is NOT loaded (modals won't work).");
}

  const STRIPE_PUBLISHABLE_KEY1 = "pk_test_51Sq16QFD4yDFFH6VTXLqqfunPtYWjQp7y57AFljPwe0GRdJ46Ad3jhIisbe7EupPIzcAylF7tZNlRiBtQMXVm6Vi00IbFeXSap";
  const BACKEND_BASE2 = "http://localhost/webprogramming2025-milestone2/backend";

  let stripe = null;
  let elements = null;

  function safeText(val) {
    return (val === null || val === undefined) ? "" : String(val);
  }

  function getJwtPayload(token) {
    try {
      const base64Url = token.split(".")[1];
      const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
      return JSON.parse(decodeURIComponent(atob(base64).split("").map(c =>
        "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)
      ).join("")));
    } catch {
      return null;
    }
  }

  async function loadProductDetails() {
    const id = localStorage.getItem("selected_product_id");
    stripe = stripe || null;
    elements = null;

    if (!id) {
      $("#productName").text("No product selected");
      $("#purchaseArea").html(`<a class="btn btn-outline-dark" href="#products">Back to products</a>`);
      return;
    }

    try {
      const product = await productService.getProductById(id);

      $("#productName").text(safeText(product.productName));
      $("#productPrice").text("$" + parseFloat(product.productPrice).toFixed(2));
      $("#productDescription").text(safeText(product.productDescription || ""));
      $("#productSeller").text(safeText(product.sellerName || "Unknown seller"));

      $("#productImage")
        .attr("src", `${BACKEND_BASE2}/${safeText(product.productImage)}`)
        .attr("alt", safeText(product.productName));

      const isSold = product.isSold == 1;
      const token = localStorage.getItem("jwt_token");

      let isOwner = false;
      if (token) {
        const payload = getJwtPayload(token);
        isOwner = String(payload?.user?.userId) === String(product.sellerId);

      }

      // SOLD
      if (isSold) {
        $("#purchaseArea").html(`<button class="btn btn-danger" disabled>Sold</button>`);
      }
      // OWNER
      else if (isOwner) {
        $("#purchaseArea").html(`<div class="text-muted">This is your listing.</div>`);
        $("#ownerArea").html(`
  <div class="d-flex gap-2">
    <button class="btn btn-outline-primary" id="editListingBtn">Edit listing</button>
    <button class="btn btn-outline-danger" id="deleteListingBtn">Delete listing</button>
  </div>
`);

      }
      // NOT LOGGED IN
      else if (!token) {
        $("#purchaseArea").html(`<a class="btn btn-outline-dark" href="#login">Login to purchase</a>`);
      }
      // BUYER
      else {
        $("#purchaseArea").html(`
          <button class="btn btn-success" id="checkoutBtn">Checkout</button>
          <div id="checkoutSection" class="mt-3" style="display:none;">
            <div class="small text-muted mb-2">Demo checkout (Stripe test mode)</div>
            <div id="payment-element"></div>
            <button class="btn btn-primary mt-3" id="confirmPaymentBtn" disabled>Pay</button>
            <div id="paymentMessage" class="mt-2"></div>
          </div>
        `);

        $(document).off("click", "#checkoutBtn").on("click", "#checkoutBtn", () => startStripeCheckout(Number(id)));
        $(document).off("click", "#confirmPaymentBtn").on("click", "#confirmPaymentBtn", confirmStripePayment);
      }

    } catch (e) {
      console.error(e);
      $("#productName").text("Failed to load product");
    }
  }

 // Put this near the top of your script (outside the function)
let paymentElement = null; // keep outside so it doesn't get GC'd

async function startStripeCheckout(productId) {
  try {
    const intentData = await paymentService.createStripeIntent(productId);

    // Save for polling later
    lastStripePaymentId = intentData.paymentId;
    lastStripeProductId = intentData.productId;

    stripe = stripe || Stripe(STRIPE_PUBLISHABLE_KEY1);

    // Clear previous mount (important when switching products / retrying)
    const mountEl = document.querySelector("#payment-element");
    if (!mountEl) throw new Error("#payment-element not found");
    mountEl.innerHTML = "";

    elements = stripe.elements({ clientSecret: intentData.clientSecret });

    paymentElement = elements.create("payment");
    paymentElement.mount("#payment-element");

    $("#checkoutSection").show();
    $("#paymentMessage").text("");

    // Disable Pay until complete
    $("#confirmPaymentBtn").prop("disabled", true);

    paymentElement.on("change", (e) => {
      $("#confirmPaymentBtn").prop("disabled", !e.complete);
      if (e.error) $("#paymentMessage").text(e.error.message);
      else $("#paymentMessage").text("");
    });

  } catch (err) {
    console.error("startStripeCheckout error:", err);
    $("#checkoutSection").show();
    $("#paymentMessage").text(err.message || "Failed to start checkout.");
    $("#confirmPaymentBtn").prop("disabled", true);
  }
}



async function confirmStripePayment() {
  try {
    $("#confirmPaymentBtn").prop("disabled", true).text("Processing...");
    $("#paymentMessage").text("");

    const result = await stripe.confirmPayment({
      elements,
      redirect: "if_required",
    });

    console.log("confirmPayment result:", result);

    if (result.error) {
      console.error("Stripe error:", result.error);
      $("#paymentMessage").text(result.error.message || "Payment failed.");
      $("#confirmPaymentBtn").prop("disabled", false).text("Pay");
      return;
    }

    // No error: the PaymentIntent is succeeded/processing.
    $("#paymentMessage").text("Payment sent. Waiting for confirmation...");

    // Start polling your backend until webhook marks it succeeded
    await waitForStripeConfirmationAndRefresh();

  } catch (e) {
    console.error(e);
    $("#paymentMessage").text("Unexpected error confirming payment.");
    $("#confirmPaymentBtn").prop("disabled", false).text("Pay");
  }
}

async function waitForStripeConfirmationAndRefresh() {
  const token = localStorage.getItem("jwt_token");
  if (!token) return;

  if (!lastStripePaymentId) {
    $("#paymentMessage").text("Missing payment reference. Please refresh and try again.");
    return;
  }

  const start = Date.now();
  const timeoutMs = 25000;     // 25s total
  const intervalMs = 1500;     // poll every 1.5s

  while (Date.now() - start < timeoutMs) {
    try {
      const res = await fetch(`${BACKEND_BASE2}/stripe/payment-status/${lastStripePaymentId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) {
        // If backend temporarily errors, keep trying a few times
        await new Promise(r => setTimeout(r, intervalMs));
        continue;
      }

      const data = await res.json();
      const status = (data.status || "").toLowerCase();

      if (status === "succeeded") {
        $("#paymentMessage").text("Payment confirmed ✅");
        await loadProductDetails(); // this will show Sold automatically
        return;
      }

      if (status === "failed") {
        $("#paymentMessage").text("Payment failed. Please try again.");
        $("#confirmPaymentBtn").prop("disabled", false).text("Pay");
        return;
      }

      // pending: keep waiting
      await new Promise(r => setTimeout(r, intervalMs));

    } catch (e) {
      console.error("poll status error:", e);
      await new Promise(r => setTimeout(r, intervalMs));
    }
  }

  $("#paymentMessage").text("Still waiting… If it doesn’t update, refresh once.");
}


  // EDIT BUTTON
  $(document).on("click", "#editListingBtn", async () => {
    const id = localStorage.getItem("selected_product_id");
    const product = await productService.getProductById(id);

    $("#editProductName").val(product.productName);
    $("#editProductPrice").val(product.productPrice);
    $("#editProductDescription").val(product.productDescription);
    $("#editProductImage").val("");

    new bootstrap.Modal(document.getElementById("editProductModal")).show();
  });

  // SAVE EDIT
  $(document).on("click", "#saveEditBtn", async () => {
    const id = localStorage.getItem("selected_product_id");
    const current = await productService.getProductById(id);

    const fd = new FormData();
    if ($("#editProductName").val() !== current.productName)
      fd.append("productName", $("#editProductName").val());
    if ($("#editProductPrice").val() != current.productPrice)
      fd.append("productPrice", $("#editProductPrice").val());
    if ($("#editProductDescription").val() !== current.productDescription)
      fd.append("productDescription", $("#editProductDescription").val());
    if ($("#editProductImage")[0].files[0])
      fd.append("productImage", $("#editProductImage")[0].files[0]);

    if (![...fd.keys()].length) {
      $("#editError").removeClass("d-none").text("No changes detected.");
      return;
    }

    try {
      await productService.editMyProduct(id, fd);
      await loadProductDetails();
      bootstrap.Modal.getInstance(document.getElementById("editProductModal")).hide();
    } catch (e) {
      $("#editError").removeClass("d-none").text("Failed to update listing.");
    }
  });
  // Open delete confirm
$(document).off("click", "#deleteListingBtn");
$(document).on("click", "#deleteListingBtn", () => {
  $("#deleteError").addClass("d-none").text("");
  const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
  modal.show();
});

// Confirm delete
$(document).off("click", "#confirmDeleteBtn");
$(document).on("click", "#confirmDeleteBtn", async () => {
  const id = localStorage.getItem("selected_product_id");
  if (!id) return;

  $("#confirmDeleteBtn").prop("disabled", true).text("Deleting...");
  $("#deleteError").addClass("d-none").text("");

  try {
    await productService.deleteMyProduct(id);

    // close modal
    const modalEl = document.getElementById("deleteConfirmModal");
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    modalInstance?.hide();

    // clear selected product and go back
    localStorage.removeItem("selected_product_id");
    window.location.hash = "#products";

  } catch (xhr) {
    let msg = "Failed to delete listing.";
    if (xhr?.responseText) {
      try {
        const parsed = JSON.parse(xhr.responseText);
        msg = parsed.error || msg;
      } catch {
        msg = xhr.responseText || msg;
      }
    }
    $("#deleteError").removeClass("d-none").text(msg);
  } finally {
    $("#confirmDeleteBtn").prop("disabled", false).text("Yes, delete");
  }
});

  function runIfOnProductRoute() {
  if (window.location.hash === "#product") {
    loadProductDetails();
  }
}

// run when the view script first loads
runIfOnProductRoute();

// run every time the hash changes (so product 2 loads immediately)
window.removeEventListener("hashchange", runIfOnProductRoute);
window.addEventListener("hashchange", runIfOnProductRoute);

</script>
